{% extends 'twitter/base.html' %}

{% block content %}
<!-- Cabe√ßalho Fixo -->
<div class="sticky top-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-b dark:border-gray-800 p-4 z-10">
    <h2 class="text-xl font-bold text-gray-800 dark:text-white">P√°gina Inicial</h2>
</div>

<!-- Caixa de Nova Postagem -->
<div class="p-4 border-b dark:border-gray-800 flex space-x-4 bg-white dark:bg-gray-900">
    <a href="{% url 'profile' user.username %}" class="shrink-0">
        <img src="{{ user.profile_pic.url }}" class="h-12 w-12 rounded-full object-cover shadow-sm">
    </a>
    
    <!-- enctype permite o envio de fotos e v√≠deos -->
    <form method="POST" enctype="multipart/form-data" class="flex-1">
        {% csrf_token %}
        <div class="w-full">
            {{ form.content }}
        </div>

        <!-- FEEDBACK VISUAL: Aparece quando voc√™ seleciona uma foto ou v√≠deo -->
        <div id="file-preview-container" class="hidden mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-xl flex items-center justify-between">
            <div class="flex items-center space-x-2 overflow-hidden">
                <span id="file-icon" class="text-lg"></span>
                <span id="file-name" class="text-sm text-blue-600 dark:text-blue-400 font-medium truncate"></span>
            </div>
            <button type="button" onclick="clearFileInputs()" class="text-blue-500 hover:text-red-500 font-bold p-1">‚úï</button>
        </div>

        <div class="flex items-center justify-between mt-3 border-t dark:border-gray-800 pt-3">
            <div class="flex space-x-2 text-blue-500">
                <!-- Bot√£o Foto -->
                <label class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 p-2 rounded-full transition" title="Adicionar Imagem">
                    <span class="text-xl">üñºÔ∏è</span>
                    <input type="file" name="image" id="input-image" accept="image/*" class="hidden" onchange="handleFileSelect(this, 'üñºÔ∏è')">
                </label>
                <!-- Bot√£o V√≠deo -->
                <label class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 p-2 rounded-full transition" title="Adicionar V√≠deo">
                    <span class="text-xl">üé•</span>
                    <input type="file" name="video" id="input-video" accept="video/*" class="hidden" onchange="handleFileSelect(this, 'üé•')">
                </label>
            </div>

            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full font-bold transition shadow-sm">
                Postar
            </button>
        </div>
    </form>
</div>

<!-- O Feed -->
<div class="divide-y dark:divide-gray-800 bg-white dark:bg-gray-900 min-h-screen">
    {% for post in posts %}
    <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-800/30 transition">
        
        <!-- Se for Retweet -->
        {% if post.repost_of %}
        <div class="flex items-center space-x-2 text-gray-500 text-sm font-bold mb-2 ml-10">
            <span>üîÑ</span>
            <span>{% if post.author == user %}Voc√™{% else %}{{ post.author.username }}{% endif %} retuitou</span>
        </div>
        {% endif %}

        <div class="flex space-x-3">
            {% with original_post=post.repost_of|default:post %}
            <a href="{% url 'profile' original_post.author.username %}" class="shrink-0">
                <img src="{{ original_post.author.profile_pic.url }}" class="h-12 w-12 rounded-full object-cover hover:opacity-90">
            </a>

            <div class="flex-1">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <a href="{% url 'profile' original_post.author.username %}" class="font-bold text-gray-900 dark:text-white hover:underline">
                            {{ original_post.author.username }}
                        </a>
                        <span class="text-gray-500 text-sm">@{{ original_post.author.username }} ¬∑ {{ original_post.created_at|timesince }}</span>
                    </div>
                    {% if post.author == request.user %}
                    <a href="{% url 'delete_post' post.id %}" onclick="return confirm('Excluir postagem?')" class="text-gray-400 hover:text-red-500">üóëÔ∏è</a>
                    {% endif %}
                </div>

                <p class="text-gray-800 dark:text-gray-200 mt-1 leading-relaxed">{{ original_post.content }}</p>

                <!-- Fotos -->
                {% if original_post.image %}
                <div class="mt-3 rounded-2xl overflow-hidden border dark:border-gray-800">
                    <img src="{{ original_post.image.url }}" class="w-full max-h-[500px] object-cover bg-gray-100 dark:bg-gray-800">
                </div>
                {% endif %}

                <!-- V√≠deos -->
                {% if original_post.video %}
                <div class="mt-3 rounded-2xl overflow-hidden border dark:border-gray-800 bg-black">
                    <video controls class="w-full max-h-[500px]">
                        <source src="{{ original_post.video.url }}" type="video/mp4">
                        Seu navegador n√£o suporta v√≠deos.
                    </video>
                </div>
                {% endif %}

                <!-- A√ß√µes -->
                <div class="flex mt-4 justify-between max-w-md text-gray-500">
                    <div class="flex items-center space-x-2 group cursor-pointer">
                        <div class="p-2 group-hover:bg-blue-50 dark:group-hover:bg-blue-900/20 group-hover:text-blue-500 rounded-full transition">
                            <span>üí¨</span>
                        </div>
                        <span class="text-sm">{{ original_post.comments.count }}</span>
                    </div>

                    <a href="{% url 'retweet' original_post.id %}" class="flex items-center space-x-2 group">
                        <div class="p-2 group-hover:bg-green-50 dark:group-hover:bg-green-900/20 group-hover:text-green-500 rounded-full transition">
                            <span class="{% if post.repost_of %}text-green-500{% endif %}">üîÑ</span>
                        </div>
                        <span class="text-sm group-hover:text-green-500">{{ original_post.reposts.count }}</span>
                    </a>

                    <a href="{% url 'like_post' original_post.id %}" class="flex items-center space-x-2 group">
                        <div class="p-2 group-hover:bg-red-50 dark:group-hover:bg-red-900/20 group-hover:text-red-500 rounded-full transition">
                            {% if request.user in original_post.likes.all %}<span class="text-red-500">‚ù§Ô∏è</span>{% else %}<span class="text-gray-400">ü§ç</span>{% endif %}
                        </div>
                        <span class="text-sm {% if request.user in original_post.likes.all %}text-red-500{% endif %}">{{ original_post.likes.count }}</span>
                    </a>
                </div>
            </div>
            {% endwith %}
        </div>
    </div>
    {% empty %}
    <div class="p-10 text-center text-gray-500">Nada por aqui ainda.</div>
    {% endfor %}
</div>

<!-- Scripts para o Feedback Visual -->
<script>
    function handleFileSelect(input, icon) {
        const container = document.getElementById('file-preview-container');
        const nameSpan = document.getElementById('file-name');
        const iconSpan = document.getElementById('file-icon');
        
        if (input.files && input.files[0]) {
            // Se selecionou um, limpa o outro (Twitter s√≥ permite 1 m√≠dia por vez no seu c√≥digo atual)
            if (input.id === 'input-image') document.getElementById('input-video').value = "";
            else document.getElementById('input-image').value = "";

            container.classList.remove('hidden');
            iconSpan.innerText = icon;
            nameSpan.innerText = input.files[0].name;
        }
    }

    function clearFileInputs() {
        document.getElementById('input-image').value = "";
        document.getElementById('input-video').value = "";
        document.getElementById('file-preview-container').classList.add('hidden');
    }
</script>
{% endblock %}
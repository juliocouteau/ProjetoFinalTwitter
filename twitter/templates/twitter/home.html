{% extends 'twitter/base.html' %}

{% block content %}
<div class="sticky top-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-b dark:border-gray-800 p-4 z-10">
    <h2 class="text-xl font-bold text-gray-800 dark:text-white">P√°gina Inicial</h2>
</div>

<!-- Caixa de Postagem -->
<div class="p-4 border-b dark:border-gray-800 flex space-x-4 bg-white dark:bg-gray-900">
    <a href="{% url 'profile' user.username %}" class="shrink-0">
        <img src="{{ user.profile_pic.url }}" class="h-12 w-12 rounded-full object-cover">
    </a>
    <form method="POST" enctype="multipart/form-data" class="flex-1">
        {% csrf_token %}
        <div class="w-full">{{ form.content }}</div>
        <div id="file-preview-container" class="hidden mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-xl flex items-center justify-between">
            <div class="flex items-center space-x-2"><span id="file-icon"></span><span id="file-name" class="text-sm text-blue-600 dark:text-blue-400"></span></div>
            <button type="button" onclick="clearFileInputs()" class="text-red-500 font-bold">‚úï</button>
        </div>
        <div class="flex items-center justify-between mt-3 border-t dark:border-gray-800 pt-3">
            <div class="flex space-x-2 text-blue-500">
                <label class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 p-2 rounded-full transition">üñºÔ∏è<input type="file" name="image" id="input-image" accept="image/*" class="hidden" onchange="handleFileSelect(this, 'üñºÔ∏è')"></label>
                <label class="cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 p-2 rounded-full transition">üé•<input type="file" name="video" id="input-video" accept="video/*" class="hidden" onchange="handleFileSelect(this, 'üé•')"></label>
            </div>
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full font-bold transition">Postar</button>
        </div>
    </form>
</div>

<!-- Feed -->
<div class="divide-y dark:divide-gray-800 bg-white dark:bg-gray-900 min-h-screen">
    {% for post in posts %}
    <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-800/30 transition">
        {% if post.repost_of %}
        <div class="flex items-center space-x-2 text-gray-500 text-sm font-bold mb-2 ml-10"><span>üîÑ</span><span>{% if post.author == user %}Voc√™{% else %}{{ post.author.username }}{% endif %} retuitou</span></div>
        {% endif %}

        <div class="flex space-x-3">
            {% with original_post=post.repost_of|default:post %}
            <a href="{% url 'profile' original_post.author.username %}" class="shrink-0"><img src="{{ original_post.author.profile_pic.url }}" class="h-12 w-12 rounded-full object-cover"></a>

            <div class="flex-1">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <a href="{% url 'profile' original_post.author.username %}" class="font-bold dark:text-white hover:underline">{{ original_post.author.username }}</a>
                        <span class="text-gray-500 text-sm">@{{ original_post.author.username }} ¬∑ {{ original_post.created_at|timesince }}</span>
                    </div>
                    {% if post.author == request.user %}
                    <a href="{% url 'delete_post' post.id %}" onclick="return confirm('Excluir?')" class="text-gray-400 hover:text-red-500">üóëÔ∏è</a>
                    {% endif %}
                </div>
                <p class="text-gray-800 dark:text-gray-200 mt-1">{{ original_post.content }}</p>
                {% if original_post.image %}<img src="{{ original_post.image.url }}" class="mt-3 rounded-2xl w-full border dark:border-gray-800 max-h-96 object-cover">{% endif %}
                {% if original_post.video %}<video controls class="mt-3 rounded-2xl w-full border dark:border-gray-800"><source src="{{ original_post.video.url }}" type="video/mp4"></video>{% endif %}

                <!-- A√ß√µes -->
                <div class="flex mt-4 justify-between max-w-md text-gray-500">
                    <button onclick="toggleCommentSection('{{ post.id }}')" class="flex items-center space-x-2 group outline-none">
                        <div class="p-2 group-hover:bg-blue-50 dark:group-hover:bg-blue-900/20 group-hover:text-blue-500 rounded-full transition"><span>üí¨</span></div>
                        <span class="text-sm">{{ original_post.comments.count }}</span>
                    </button>

                    <!-- BOT√ÉO RETWEET AJAX -->
                    <button onclick="retweetPost(this, '{{ original_post.id }}')" class="flex items-center space-x-2 group outline-none">
                        <div class="p-2 group-hover:bg-green-50 dark:group-hover:bg-green-900/20 group-hover:text-green-500 rounded-full transition">
                            <span class="rt-icon {% if post.repost_of %}text-green-500{% endif %}">üîÑ</span>
                        </div>
                        <span class="text-sm rt-count {% if post.repost_of %}text-green-500{% endif %}">{{ original_post.reposts.count }}</span>
                    </button>

                    <!-- BOT√ÉO LIKE AJAX -->
                    <button onclick="likePost(this, '{{ original_post.id }}')" class="flex items-center space-x-2 group outline-none">
                        <div class="p-2 group-hover:bg-red-50 dark:group-hover:bg-red-900/20 group-hover:text-red-500 rounded-full transition">
                            <span class="heart-icon">{% if request.user in original_post.likes.all %}<span class="text-red-500">‚ù§Ô∏è</span>{% else %}<span>ü§ç</span>{% endif %}</span>
                        </div>
                        <span class="text-sm like-count {% if request.user in original_post.likes.all %}text-red-500{% endif %}">{{ original_post.likes.count }}</span>
                    </button>
                </div>

                <div id="comment-section-{{ post.id }}" class="hidden mt-4 pt-4 border-t dark:border-gray-800">
                    {% for comment in original_post.comments.all %}<div class="flex items-start space-x-2 mb-3"><img src="{{ comment.author.profile_pic.url }}" class="h-8 w-8 rounded-full object-cover"><div class="bg-gray-100 dark:bg-gray-800 rounded-2xl px-3 py-2 flex-1"><p class="text-xs font-bold dark:text-white">@{{ comment.author.username }}</p><p class="text-sm dark:text-gray-300">{{ comment.content }}</p></div></div>{% endfor %}
                    <form action="{% url 'add_comment' original_post.id %}" method="POST" class="flex items-center space-x-2">{% csrf_token %}<input type="text" name="content" placeholder="Resposta..." required class="flex-1 bg-gray-100 dark:bg-gray-800 border-none rounded-full px-4 py-1.5 text-sm dark:text-white outline-none focus:ring-1 focus:ring-blue-500"></form>
                </div>
            </div>
            {% endwith %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
    // AJAX LIKE
    async function likePost(btn, postId) {
        const response = await fetch(`/like/${postId}/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (response.ok) {
            const data = await response.json();
            const heartSpan = btn.querySelector('.heart-icon');
            const countSpan = btn.querySelector('.like-count');
            if (data.liked) { heartSpan.innerHTML = '<span class="text-red-500">‚ù§Ô∏è</span>'; countSpan.classList.add('text-red-500'); }
            else { heartSpan.innerHTML = '<span>ü§ç</span>'; countSpan.classList.remove('text-red-500'); }
            countSpan.innerText = data.count;
        }
    }

    // AJAX RETWEET
    async function retweetPost(btn, postId) {
        const response = await fetch(`/retweet/${postId}/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (response.ok) {
            const data = await response.json();
            const rtIcon = btn.querySelector('.rt-icon');
            const countSpan = btn.querySelector('.rt-count');
            if (data.retweeted) { rtIcon.classList.add('text-green-500'); countSpan.classList.add('text-green-500'); }
            else { rtIcon.classList.remove('text-green-500'); countSpan.classList.remove('text-green-500'); }
            countSpan.innerText = data.count;
            // Opcional: Recarregar a p√°gina apenas se quiser ver o novo post na timeline na hora
            // location.reload(); 
        }
    }

    function toggleCommentSection(postId) { document.getElementById('comment-section-' + postId).classList.toggle('hidden'); }
    function handleFileSelect(input, icon) { const container = document.getElementById('file-preview-container'); const nameSpan = document.getElementById('file-name'); const iconSpan = document.getElementById('file-icon'); if (input.files && input.files[0]) { container.classList.remove('hidden'); iconSpan.innerText = icon; nameSpan.innerText = input.files[0].name; } }
    function clearFileInputs() { document.getElementById('input-image').value = ""; document.getElementById('input-video').value = ""; document.getElementById('file-preview-container').classList.add('hidden'); }
</script>
{% endblock %}
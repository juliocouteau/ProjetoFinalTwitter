{% extends 'twitter/base.html' %}

{% block content %}
<div class="min-h-screen bg-white dark:bg-gray-900">
    <div class="flex items-center space-x-4 p-3 sticky top-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md z-10 border-b dark:border-gray-800">
        <a href="{% url 'home' %}" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition text-black dark:text-white">‚¨ÖÔ∏è</a>
        <div><h2 class="text-xl font-bold dark:text-white">{{ view_user.username }}</h2><span class="text-gray-500 text-sm">{{ posts.count }} Posts</span></div>
    </div>

    <div class="h-48 bg-gray-200 dark:bg-gray-800 w-full relative overflow-hidden">
        {% if view_user.cover_image %}<img src="{{ view_user.cover_image.url }}" class="w-full h-full object-cover">{% endif %}
    </div>

    <div class="px-4 pb-4">
        <div class="relative flex justify-between items-end -mt-16 mb-4">
            <img src="{{ view_user.profile_pic.url }}" class="h-32 w-32 rounded-full border-4 border-white dark:border-gray-900 object-cover bg-gray-300 shadow-sm">
            <div class="mb-2">
                {% if user == view_user %}
                <a href="{% url 'edit_profile' %}" class="border dark:border-gray-700 px-4 py-2 rounded-full font-bold dark:text-white">Editar Perfil</a>
                {% else %}
                <a href="{% url 'follow_unfollow' view_user.username %}" class="bg-black dark:bg-white text-white dark:text-black px-5 py-2 rounded-full font-bold">{% if view_user in user.following.all %}Seguindo{% else %}Seguir{% endif %}</a>
                {% endif %}
            </div>
        </div>
        <h2 class="text-2xl font-black dark:text-white">{{ view_user.username }}</h2>
        <span class="text-gray-500">@{{ view_user.username }}</span>
        <div class="mt-3 dark:text-gray-200">{{ view_user.bio|default:"Sem biografia." }}</div>
        <div class="flex space-x-4 mt-4 text-sm">
            <a href="{% url 'following_list' view_user.username %}" class="dark:text-white"><span class="font-bold">{{ view_user.following.count }}</span> Seguindo</a>
            <a href="{% url 'followers_list' view_user.username %}" class="dark:text-white"><span class="font-bold">{{ view_user.followers.count }}</span> Seguidores</a>
        </div>
    </div>

    <div class="divide-y dark:divide-gray-800 border-t dark:border-gray-800">
        {% for post in posts %}
        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition">
            {% if post.repost_of %}<div class="flex items-center space-x-2 text-gray-500 text-sm font-bold mb-2 ml-10"><span>üîÑ</span><span>{{ view_user.username }} retuitou</span></div>{% endif %}

            <div class="flex space-x-3">
                {% with original_post=post.repost_of|default:post %}
                <a href="{% url 'profile' original_post.author.username %}" class="shrink-0"><img src="{{ original_post.author.profile_pic.url }}" class="h-12 w-12 rounded-full object-cover"></a>
                <div class="flex-1">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2"><span class="font-bold dark:text-white">{{ original_post.author.username }}</span><span class="text-gray-500 text-sm">@{{ original_post.author.username }} ¬∑ {{ original_post.created_at|timesince }}</span></div>
                        {% if post.author == request.user %}<a href="{% url 'delete_post' post.id %}" onclick="return confirm('Excluir?')" class="text-gray-400 hover:text-red-500 transition">üóëÔ∏è</a>{% endif %}
                    </div>
                    <p class="mt-1 dark:text-gray-200">{{ original_post.content }}</p>
                    {% if original_post.image %}<img src="{{ original_post.image.url }}" class="mt-3 rounded-2xl w-full border dark:border-gray-800">{% endif %}
                    {% if original_post.video %}<video controls class="mt-3 rounded-2xl w-full border dark:border-gray-800"><source src="{{ original_post.video.url }}" type="video/mp4"></video>{% endif %}

                    <!-- A√ß√µes AJAX -->
                    <div class="flex mt-4 justify-between max-w-md text-gray-500">
                        <button onclick="toggleCommentSection('{{ post.id }}')" class="flex items-center space-x-2 outline-none"><span>üí¨</span> <span class="text-sm">{{ original_post.comments.count }}</span></button>
                        
                        <!-- BOT√ÉO RETWEET AJAX -->
                        <button onclick="retweetPost(this, '{{ original_post.id }}')" class="flex items-center space-x-2 outline-none">
                            <span class="rt-icon {% if post.repost_of %}text-green-500{% endif %}">üîÑ</span>
                            <span class="text-sm rt-count {% if post.repost_of %}text-green-500{% endif %}">{{ original_post.reposts.count }}</span>
                        </button>

                        <button onclick="likePost(this, '{{ original_post.id }}')" class="flex items-center space-x-2 outline-none">
                            <span class="heart-icon">{% if request.user in original_post.likes.all %}<span class="text-red-500">‚ù§Ô∏è</span>{% else %}<span>ü§ç</span>{% endif %}</span>
                            <span class="text-sm like-count {% if request.user in original_post.likes.all %}text-red-500{% endif %}">{{ original_post.likes.count }}</span>
                        </button>
                    </div>

                    <div id="comment-section-{{ post.id }}" class="hidden mt-4 pt-4 border-t dark:border-gray-800">
                        {% for comment in original_post.comments.all %}<div class="flex items-start space-x-2 mb-2"><img src="{{ comment.author.profile_pic.url }}" class="h-6 w-6 rounded-full"><div class="bg-gray-100 dark:bg-gray-800 rounded-2xl px-3 py-1 flex-1 text-sm"><p class="font-bold">@{{ comment.author.username }}</p><p>{{ comment.content }}</p></div></div>{% endfor %}
                        <form action="{% url 'add_comment' original_post.id %}" method="POST" class="mt-2"><input type="text" name="content" placeholder="Resposta..." class="w-full bg-gray-100 dark:bg-gray-800 rounded-full px-4 py-1.5 text-sm dark:text-white outline-none"></form>
                    </div>
                </div>
                {% endwith %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    async function likePost(btn, postId) {
        const response = await fetch(`/like/${postId}/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (response.ok) {
            const data = await response.json();
            const heartSpan = btn.querySelector('.heart-icon');
            const countSpan = btn.querySelector('.like-count');
            if (data.liked) { heartSpan.innerHTML = '<span class="text-red-500">‚ù§Ô∏è</span>'; countSpan.classList.add('text-red-500'); }
            else { heartSpan.innerHTML = '<span>ü§ç</span>'; countSpan.classList.remove('text-red-500'); }
            countSpan.innerText = data.count;
        }
    }

    async function retweetPost(btn, postId) {
        const response = await fetch(`/retweet/${postId}/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (response.ok) {
            const data = await response.json();
            const rtIcon = btn.querySelector('.rt-icon');
            const countSpan = btn.querySelector('.rt-count');
            if (data.retweeted) { rtIcon.classList.add('text-green-500'); countSpan.classList.add('text-green-500'); }
            else { rtIcon.classList.remove('text-green-500'); countSpan.classList.remove('text-green-500'); }
            countSpan.innerText = data.count;
        }
    }

    function toggleCommentSection(postId) { document.getElementById('comment-section-' + postId).classList.toggle('hidden'); }
</script>
{% endblock %}